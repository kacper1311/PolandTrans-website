# ========================================
# POLANDTRANS - PLIK .HTACCESS
# ========================================
# Ten plik zawiera konfigurację serwera Apache
# Optymalizuje wydajność, bezpieczeństwo i SEO

# ========================================
# WŁĄCZENIE MODUŁÓW
# ========================================
# Włączamy moduły potrzebne do optymalizacji
<IfModule mod_rewrite.c>
    RewriteEngine On
</IfModule>

# ========================================
# BEZPIECZEŃSTWO - NAGŁÓWKI
# ========================================
# Dodajemy nagłówki bezpieczeństwa
<IfModule mod_headers.c>
    # Ochrona przed XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Ochrona przed clickjacking
    Header always set X-Frame-Options "DENY"
    
    # Ochrona przed MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google.com; frame-src https://www.google.com;"
</IfModule>

# ========================================
# KOMPRESJA GZIP
# ========================================
# Kompresujemy pliki przed wysłaniem do przeglądarki
<IfModule mod_deflate.c>
    # Włączamy kompresję
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Usuwamy problemy z przeglądarkami
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# ========================================
# CACHE - PAMIĘĆ PODRĘCZNA
# ========================================
# Ustawiamy cache dla różnych typów plików
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Domyślny czas cache (1 miesiąc)
    ExpiresDefault "access plus 1 month"
    
    # HTML - 1 dzień
    ExpiresByType text/html "access plus 1 day"
    
    # CSS i JavaScript - 1 rok
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    
    # Obrazy - 1 rok
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fonty - 1 rok
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # PDF i dokumenty - 1 miesiąc
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/msword "access plus 1 month"
    ExpiresByType application/vnd.openxmlformats-officedocument.wordprocessingml.document "access plus 1 month"
</IfModule>

# ========================================
# PRZEKIEROWANIA HTTPS
# ========================================
# Przekierowujemy HTTP na HTTPS
<IfModule mod_rewrite.c>
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ========================================
# USUWANIE TRAILING SLASH
# ========================================
# Usuwamy końcowy slash z URL
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [R=301,L]
</IfModule>

# ========================================
# BLOKOWANIE DOSTĘPU DO PLIKÓW
# ========================================
# Blokujemy dostęp do wrażliwych plików
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

<Files ~ "\.(htaccess|htpasswd|ini|log|sh|sql|conf)$">
    Order allow,deny
    Deny from all
</Files>

# ========================================
# OPTYMALIZACJA OBRAZÓW
# ========================================
# Dodajemy nagłówki dla obrazów
<IfModule mod_headers.c>
    # Obrazy WebP
    <FilesMatch "\.webp$">
        Header set Cache-Control "max-age=31536000, public"
        Header set Vary "Accept"
    </FilesMatch>
    
    # Obrazy SVG
    <FilesMatch "\.svg$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
</IfModule>

# ========================================
# BLOKOWANIE BOTÓW
# ========================================
# Blokujemy złośliwe boty
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget).* [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^.*(libwww-perl|curl|wget|python|nikto|scan).* [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^.*(winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner).* [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ========================================
# OCHRONA PRZED HOTLINKING
# ========================================
# Blokujemy hotlinking obrazów
<IfModule mod_rewrite.c>
    RewriteEngine on
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?polandtrans\.pl [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?google\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?bing\. [NC]
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yahoo\. [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,L]
</IfModule>

# ========================================
# BŁĘDY 404
# ========================================
# Własna strona błędu 404
ErrorDocument 404 /404.html

# ========================================
# OPTYMALIZACJA WYDAJNOŚCI
# ========================================
# Dodajemy nagłówki dla lepszej wydajności
<IfModule mod_headers.c>
    # Keep-Alive
    Header set Connection keep-alive
    
    # Preload critical resources
    <FilesMatch "\.(css|js)$">
        Header set Link "</css/style.css>; rel=preload; as=style, </js/script.js>; rel=preload; as=script"
    </FilesMatch>
</IfModule>

# ========================================
# KOMENTARZ KOŃCOWY
# ========================================
# Ten plik został zoptymalizowany dla PolandTrans
# Zawiera wszystkie niezbędne ustawienia dla SEO, bezpieczeństwa i wydajności 